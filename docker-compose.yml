# L{CORE} Self-Hosting Docker Compose
#
# For EigenCloud deployment, deploy each service separately:
#   - cartesi-node: modernsociety/lcore-node:latest
#   - attestor: modernsociety/lcore-attestor:latest
#
# Both connect to external Supabase PostgreSQL.

services:
  # Cartesi Node - Validator with L{CORE} dApp
  cartesi-node:
    image: modernsociety/lcore-node:latest
    ports:
      - "10000:10000"
    environment:
      - CARTESI_BLOCKCHAIN_FINALITY_OFFSET=1
      - CARTESI_BLOCKCHAIN_ID=${CARTESI_BLOCKCHAIN_ID:-421614}
      - CARTESI_CONTRACTS_APPLICATION_ADDRESS=${LCORE_DAPP_ADDRESS}
      - CARTESI_CONTRACTS_AUTHORITY_ADDRESS=${CARTESI_AUTHORITY_ADDRESS}
      - CARTESI_CONTRACTS_HISTORY_ADDRESS=${CARTESI_HISTORY_ADDRESS}
      - CARTESI_CONTRACTS_INPUT_BOX_ADDRESS=${LCORE_INPUTBOX_ADDRESS:-0x59b22D57D4f067708AB0c00552767405926dc768}
      - CARTESI_CONTRACTS_INPUT_BOX_DEPLOYMENT_BLOCK_NUMBER=${CARTESI_INPUTBOX_BLOCK:-2838409}
      - CARTESI_EPOCH_LENGTH=${CARTESI_EPOCH_LENGTH:-43200}
      - CARTESI_AUTH_MNEMONIC=${MNEMONIC}
      - CARTESI_BLOCKCHAIN_HTTP_ENDPOINT=${LCORE_RPC_URL}
      - CARTESI_BLOCKCHAIN_WS_ENDPOINT=${LCORE_WS_URL}
      - CARTESI_POSTGRES_ENDPOINT=${CARTESI_POSTGRES_ENDPOINT}
      - CARTESI_EXPERIMENTAL_DISABLE_CONFIG_LOG=true
      - CARTESI_HTTP_ADDRESS=0.0.0.0
      - ROLLUP_HTTP_SERVER_URL=http://127.0.0.1:5004
    restart: unless-stopped

  # L{CORE} Attestor - TEE-based data verification with device endpoint
  attestor:
    image: modernsociety/lcore-attestor:latest
    ports:
      - "8001:8001"
    environment:
      - MNEMONIC=${MNEMONIC}
      - LCORE_ENABLED=1
      - LCORE_RPC_URL=${LCORE_RPC_URL}
      - LCORE_DAPP_ADDRESS=${LCORE_DAPP_ADDRESS}
      - LCORE_INPUTBOX_ADDRESS=${LCORE_INPUTBOX_ADDRESS:-0x59b22D57D4f067708AB0c00552767405926dc768}
      - LCORE_NODE_URL=${LCORE_NODE_URL:-http://cartesi-node:10000}
      - LCORE_ADMIN_PUBLIC_KEY=${LCORE_ADMIN_PUBLIC_KEY}
      - LCORE_ADMIN_PRIVATE_KEY=${LCORE_ADMIN_PRIVATE_KEY}
      - LOG_LEVEL=${LOG_LEVEL:-info}
    restart: unless-stopped
