# L{CORE} Self-Hosting Docker Compose
#
# Usage:
#   1. Copy .env.example to .env and fill in your values
#   2. Run: docker-compose up -d
#   3. Verify: curl http://localhost:8001/healthcheck
#
# See docs/SELF-HOSTING.md for full instructions.

services:
  # L{CORE} Attestor - TEE-based data verification
  attestor:
    image: ghcr.io/modern-society-labs/lcore-attestor:latest
    build:
      context: .
      dockerfile: attestor.dockerfile
    ports:
      - "8001:8001"
    environment:
      # L{CORE} Configuration
      - LCORE_ENABLED=1
      - LCORE_NODE_URL=http://cartesi:10000
      - LCORE_RPC_URL=${LCORE_RPC_URL}
      - LCORE_DAPP_ADDRESS=${LCORE_DAPP_ADDRESS}
      - LCORE_INPUTBOX_ADDRESS=${LCORE_INPUTBOX_ADDRESS:-0x59b22D57D4f067708AB0c00552767405926dc768}

      # Wallet Configuration
      - PRIVATE_KEY=${PRIVATE_KEY}
      - MNEMONIC=${MNEMONIC}

      # L{CORE} Encryption Keys
      - LCORE_ADMIN_PUBLIC_KEY=${LCORE_ADMIN_PUBLIC_KEY}
      - LCORE_ADMIN_PRIVATE_KEY=${LCORE_ADMIN_PRIVATE_KEY}

      # Logging
      - LOG_LEVEL=${LOG_LEVEL:-info}
    depends_on:
      - cartesi
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8001/healthcheck"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  # Cartesi Node - Deterministic compute layer with SQLite
  cartesi:
    image: ghcr.io/modern-society-labs/lcore-cartesi:latest
    build:
      context: .
      dockerfile: cartesi-node.dockerfile
    ports:
      - "10000:10000"
    environment:
      # Cartesi Configuration
      - CARTESI_HTTP_ADDRESS=0.0.0.0
      - CARTESI_BLOCKCHAIN_ID=${CARTESI_BLOCKCHAIN_ID:-421614}
      - CARTESI_BLOCKCHAIN_HTTP_ENDPOINT=${LCORE_RPC_URL}
      - CARTESI_BLOCKCHAIN_WS_ENDPOINT=${CARTESI_WS_ENDPOINT}

      # Contract Addresses
      - CARTESI_CONTRACTS_APPLICATION_ADDRESS=${LCORE_DAPP_ADDRESS}
      - CARTESI_CONTRACTS_INPUT_BOX_ADDRESS=${LCORE_INPUTBOX_ADDRESS:-0x59b22D57D4f067708AB0c00552767405926dc768}

      # Wallet
      - CARTESI_AUTH_MNEMONIC=${MNEMONIC}

      # Proof Signing
      - PROOF_SIGNING_KEY=${PROOF_SIGNING_KEY}
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:10000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    volumes:
      - cartesi-data:/data

volumes:
  cartesi-data:
    driver: local
